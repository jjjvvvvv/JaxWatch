{% extends "base.html" %}

{% block title %}Operations Dashboard - JaxWatch{% endblock %}

{% block content %}
<!-- System Status Overview -->
<div class="stats-grid">
    <div class="stat-item">
        <div class="stat-number">{{ total_projects }}</div>
        <div class="stat-label">Total Projects</div>
    </div>
    <div class="stat-item">
        <div class="stat-number">{{ enriched_count }}</div>
        <div class="stat-label">AI Verified</div>
    </div>
    <div class="stat-item">
        <div class="stat-number">{{ pending_count }}</div>
        <div class="stat-label">Pending Review</div>
    </div>
    <div class="stat-item">
        <div class="stat-number">{{ reference_count or 0 }}</div>
        <div class="stat-label">References Found</div>
    </div>
</div>

<!-- Pipeline Status Dashboard -->
<div class="card">
    <div class="card-header">üöÄ Data Pipeline Status</div>
    <div class="card-body">
        <div class="pipeline-status-grid">
            <div class="status-card">
                <div class="status-card-header">
                    <h4>üìÇ Data Collection</h4>
                    <span class="status-indicator status-success">‚óè</span>
                </div>
                <p class="status-detail">Last run: {{ collection_last_run or '4 hours ago' }}</p>
                <p class="status-detail">Documents collected: {{ total_documents or '1,142' }}</p>
                <div class="status-actions">
                    <button class="btn btn-sm" onclick="runTask('collect', 'all')">Update All</button>
                    <select id="collection-source" class="form-select btn-sm">
                        <option value="all">All Sources</option>
                        <option value="dia_board">DIA Board</option>
                        <option value="dia_ddrb">DDRB</option>
                        <option value="city_council">City Council</option>
                    </select>
                </div>
            </div>

            <div class="status-card">
                <div class="status-card-header">
                    <h4>üéØ Project Extraction</h4>
                    <span class="status-indicator status-success">‚óè</span>
                </div>
                <p class="status-detail">{{ total_projects }} projects identified</p>
                <p class="status-detail">Last extracted: {{ extraction_last_run or '2 hours ago' }}</p>
                <div class="status-actions">
                    <button class="btn btn-sm" onclick="runTask('extract', null)">Extract Projects</button>
                    <input type="number" id="extraction-year" placeholder="Year (optional)" class="form-control btn-sm" style="width: 120px;">
                </div>
            </div>

            <div class="status-card">
                <div class="status-card-header">
                    <h4>ü§ñ AI Analysis</h4>
                    <span class="status-indicator {{ 'status-success' if verification_percentage > 10 else 'status-warning' }}">‚óè</span>
                </div>
                <p class="status-detail">{{ enriched_count }} / {{ total_projects }} verified ({{ "%.1f"|format(verification_percentage or 0) }}%)</p>
                <p class="status-detail">Processing rate: {{ processing_rate or '~3 per minute' }}</p>
                <div class="status-actions">
                    <button class="btn btn-sm btn-primary" onclick="runBatch()">Process Next 10</button>
                    <input type="number" id="batch-size" value="10" min="1" max="50" class="form-control btn-sm" style="width: 60px;">
                </div>
            </div>

            <div class="status-card">
                <div class="status-card-header">
                    <h4>üîó Reference Scanning</h4>
                    <span class="status-indicator {{ 'status-success' if reference_count > 0 else 'status-warning' }}">‚óè</span>
                </div>
                <p class="status-detail">{{ reference_count or 0 }} references found</p>
                <p class="status-detail">Coverage: {{ reference_coverage or '5%' }} of projects</p>
                <div class="status-actions">
                    <button class="btn btn-sm" onclick="runTask('scan_references', 'dia_board')">Scan References</button>
                    <button class="btn btn-sm btn-secondary" onclick="runTask('scan_references', 'all')">Scan All</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Batch Operations Panel -->
<div class="card">
    <div class="card-header">
        üì¶ Bulk Project Operations
        <div class="card-header-actions">
            <span id="selection-count">0 selected</span>
            <button id="select-all" class="btn btn-sm btn-secondary" onclick="toggleSelectAll()">Select All Visible</button>
        </div>
    </div>
    <div class="card-body">
        <div class="batch-operations">
            <div class="batch-controls">
                <label><input type="checkbox" id="force-reprocess"> Force Reprocess</label>
                <label><input type="checkbox" id="include-references"> Include Reference Scanning</label>
                <button id="process-selected" class="btn btn-primary" onclick="processSelected()" disabled>Process Selected Projects</button>
            </div>

            <div class="project-selection-grid" id="project-grid">
                {% if recent_projects %}
                    {% for project in recent_projects %}
                    <div class="project-selection-item">
                        <label class="project-checkbox">
                            <input type="checkbox" class="project-select" value="{{ project.id }}" onchange="updateSelectionCount()">
                            <div class="project-info">
                                <div class="project-title">{{ project.title[:40] }}{% if project.title|length > 40 %}...{% endif %}</div>
                                <div class="project-meta">
                                    <span class="project-id">{{ project.id }}</span>
                                    <span class="project-type badge badge-{{ 'primary' if project.doc_type == 'DIA-RES' else 'secondary' }}">{{ project.doc_type }}</span>
                                    {% if project.document_verification %}
                                        <span class="badge badge-success">‚úì Verified</span>
                                    {% else %}
                                        <span class="badge badge-warning">Pending</span>
                                    {% endif %}
                                </div>
                            </div>
                        </label>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No projects available for selection.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Active Jobs Panel -->
<div class="card">
    <div class="card-header">
        ‚ö° Active Jobs
        <div class="card-header-actions">
            <button class="btn btn-sm btn-secondary" onclick="refreshJobs()">üîÑ Refresh</button>
        </div>
    </div>
    <div class="card-body">
        <div id="active-jobs">
            {% if active_jobs %}
                {% for job in active_jobs %}
                <div class="job-item" data-job-id="{{ job.id }}">
                    <div class="job-header">
                        <span class="job-title">{{ job.description }}</span>
                        <span class="job-status badge badge-{{ 'primary' if job.status == 'running' else 'success' if job.status == 'completed' else 'danger' }}">
                            {{ job.status }}
                        </span>
                    </div>
                    <div class="job-progress">
                        <div class="progress-bar {{ 'progress-animated' if job.status == 'running' else '' }}" style="width: {{ job.progress or 0 }}%"></div>
                    </div>
                    <div class="job-meta">
                        <span>Started: {{ job.started_at[:19] if job.started_at else 'Unknown' }}</span>
                        {% if job.stats %}
                            <span>Processed: {{ job.stats.get('processed', 0) }}</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-muted">No active jobs</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Advanced Operations -->
<div class="card">
    <div class="card-header">üõ†Ô∏è Advanced Operations</div>
    <div class="card-body">
        <div class="advanced-operations-grid">
            <div class="operation-section">
                <h5>Data Management</h5>
                <button class="btn btn-secondary" onclick="runTask('export_data', 'json')">üì§ Export Data (JSON)</button>
                <button class="btn btn-secondary" onclick="runTask('export_data', 'csv')">üìä Export Data (CSV)</button>
                <button class="btn btn-warning" onclick="runTask('cleanup', '30')">üßπ Cleanup Old Data (30+ days)</button>
            </div>

            <div class="operation-section">
                <h5>System Maintenance</h5>
                <button class="btn btn-info" onclick="runTask('reindex', null)">üîÑ Rebuild Index</button>
                <button class="btn btn-info" onclick="runTask('validate', null)">‚úÖ Validate Data Integrity</button>
                <button class="btn btn-secondary" onclick="showSystemLogs()">üìã View System Logs</button>
            </div>

            <div class="operation-section">
                <h5>Configuration</h5>
                <button class="btn btn-secondary" onclick="showConfig()">‚öôÔ∏è View Configuration</button>
                <button class="btn btn-secondary" onclick="runTask('test_llm', null)">üß™ Test LLM Connection</button>
                <button class="btn btn-secondary" onclick="runTask('health_check', null)">üíä Health Check</button>
            </div>
        </div>
    </div>
</div>

<!-- Navigation -->
<div class="card">
    <div class="card-header">üìç Navigate</div>
    <div class="card-body">
        <a href="{{ url_for('projects') }}" class="btn">Browse All Projects</a>
        <a href="{{ url_for('projects', enhanced='no') }}" class="btn btn-secondary">View Unverified Projects</a>
        <a href="/api/status" target="_blank" class="btn btn-info">API Status (JSON)</a>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Global job management
let activeJobs = new Map();
let pollingInterval = null;

// Start job polling
function startJobPolling() {
    if (pollingInterval) return;

    pollingInterval = setInterval(() => {
        refreshJobs();
    }, 2000); // Poll every 2 seconds
}

// Stop job polling
function stopJobPolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
    }
}

// Start polling when page loads
document.addEventListener('DOMContentLoaded', startJobPolling);
window.addEventListener('beforeunload', stopJobPolling);

// Task execution
function runTask(taskType, params = null) {
    const payload = {
        task: taskType,
        params: collectTaskParams(taskType, params)
    };

    showJobProgress(taskType, 'Starting...');

    fetch('/api/jobs/start', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            activeJobs.set(data.job_id, { type: taskType, status: 'running' });
            showNotification(`Started ${taskType} job`, 'success');
        } else {
            showNotification(`Failed to start ${taskType}: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        showNotification(`Error starting ${taskType}: ${error}`, 'error');
    });
}

function collectTaskParams(taskType, params) {
    const result = { type: taskType };

    if (params) {
        result.params = params;
    }

    switch (taskType) {
        case 'collect':
            result.source = document.getElementById('collection-source')?.value || 'all';
            break;
        case 'extract':
            const year = document.getElementById('extraction-year')?.value;
            if (year) result.year = parseInt(year);
            break;
        case 'verify_batch':
            result.batch_size = parseInt(document.getElementById('batch-size')?.value || 10);
            result.force = document.getElementById('force-reprocess')?.checked || false;
            break;
        case 'scan_references':
            result.source = params || 'all';
            break;
    }

    return result;
}

function runBatch() {
    const batchSize = parseInt(document.getElementById('batch-size').value);
    const force = document.getElementById('force-reprocess').checked;

    runTask('verify_batch', { size: batchSize, force: force });
}

function processSelected() {
    const selected = Array.from(document.querySelectorAll('.project-select:checked')).map(cb => cb.value);

    if (selected.length === 0) {
        showNotification('No projects selected', 'warning');
        return;
    }

    const force = document.getElementById('force-reprocess').checked;
    const includeRefs = document.getElementById('include-references').checked;

    const payload = {
        task: 'process_selected',
        params: {
            project_ids: selected,
            force: force,
            include_references: includeRefs
        }
    };

    fetch('/api/jobs/start', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`Started processing ${selected.length} projects`, 'success');
            // Clear selections
            document.querySelectorAll('.project-select:checked').forEach(cb => cb.checked = false);
            updateSelectionCount();
        } else {
            showNotification(`Failed to start batch processing: ${data.error}`, 'error');
        }
    });
}

function toggleSelectAll() {
    const checkboxes = document.querySelectorAll('.project-select');
    const selectAllBtn = document.getElementById('select-all');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);

    checkboxes.forEach(cb => {
        cb.checked = !allChecked;
    });

    selectAllBtn.textContent = allChecked ? 'Select All Visible' : 'Clear Selection';
    updateSelectionCount();
}

function updateSelectionCount() {
    const selected = document.querySelectorAll('.project-select:checked').length;
    document.getElementById('selection-count').textContent = `${selected} selected`;
    document.getElementById('process-selected').disabled = selected === 0;
}

function refreshJobs() {
    fetch('/api/jobs/status')
        .then(response => response.json())
        .then(data => {
            updateJobsDisplay(data.jobs || []);
        })
        .catch(error => {
            console.error('Failed to refresh jobs:', error);
        });
}

function updateJobsDisplay(jobs) {
    const container = document.getElementById('active-jobs');

    if (jobs.length === 0) {
        container.innerHTML = '<p class="text-muted">No active jobs</p>';
        return;
    }

    const jobsHtml = jobs.map(job => `
        <div class="job-item" data-job-id="${job.id}">
            <div class="job-header">
                <span class="job-title">${job.description}</span>
                <span class="job-status badge badge-${getStatusClass(job.status)}">${job.status}</span>
            </div>
            <div class="job-progress">
                <div class="progress-bar ${job.status === 'running' ? 'progress-animated' : ''}"
                     style="width: ${job.progress || 0}%"></div>
            </div>
            <div class="job-meta">
                <span>Started: ${job.started_at ? job.started_at.substring(0, 19) : 'Unknown'}</span>
                ${job.stats ? `<span>Processed: ${job.stats.processed || 0}</span>` : ''}
            </div>
        </div>
    `).join('');

    container.innerHTML = jobsHtml;
}

function getStatusClass(status) {
    switch (status) {
        case 'running': return 'primary';
        case 'completed': return 'success';
        case 'failed': return 'danger';
        case 'cancelled': return 'warning';
        default: return 'secondary';
    }
}

function showJobProgress(taskType, message) {
    // Implementation for showing job progress
    showNotification(`${taskType}: ${message}`, 'info');
}

function showNotification(message, type = 'info') {
    // Simple notification system
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} notification`;
    notification.textContent = message;
    notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 1000; min-width: 300px;';

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.remove();
    }, 5000);
}

function showSystemLogs() {
    // Implementation for showing system logs
    window.open('/api/logs', '_blank');
}

function showConfig() {
    // Implementation for showing configuration
    window.open('/api/config', '_blank');
}

// Legacy support for existing buttons
document.addEventListener('DOMContentLoaded', function() {
    const runDemoBtn = document.getElementById('run-demo');
    const runLiveBtn = document.getElementById('run-live');

    if (runDemoBtn) {
        runDemoBtn.addEventListener('click', () => runTask('verify_demo'));
    }

    if (runLiveBtn) {
        runLiveBtn.addEventListener('click', () => runTask('verify_live'));
    }
});
</script>

<style>
.pipeline-status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.status-card {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 1rem;
    background: #f8f9fa;
}

.status-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.status-card-header h4 {
    margin: 0;
    font-size: 1rem;
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
}

.status-success { background-color: #28a745; }
.status-warning { background-color: #ffc107; }
.status-danger { background-color: #dc3545; }
.status-unknown { background-color: #6c757d; }

.status-detail {
    margin: 0.25rem 0;
    font-size: 0.9rem;
    color: #6c757d;
}

.status-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    margin-top: 1rem;
}

.batch-operations {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.batch-controls {
    display: flex;
    gap: 1rem;
    align-items: center;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 4px;
}

.project-selection-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
}

.project-selection-item {
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 0.75rem;
    background: white;
}

.project-checkbox {
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
    cursor: pointer;
    margin: 0;
}

.project-info {
    flex: 1;
}

.project-title {
    font-weight: 500;
    margin-bottom: 0.25rem;
}

.project-meta {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    font-size: 0.8rem;
}

.project-id {
    font-family: monospace;
    background: #f1f3f4;
    padding: 0.1rem 0.3rem;
    border-radius: 2px;
}

.job-item {
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    background: white;
}

.job-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.job-title {
    font-weight: 500;
}

.job-progress {
    width: 100%;
    height: 4px;
    background: #e9ecef;
    border-radius: 2px;
    margin: 0.5rem 0;
}

.progress-bar {
    height: 100%;
    background: #007bff;
    border-radius: 2px;
    transition: width 0.3s ease;
}

.progress-animated {
    background: linear-gradient(45deg, #007bff 25%, transparent 25%, transparent 50%, #007bff 50%, #007bff 75%, transparent 75%);
    background-size: 20px 20px;
    animation: progress-animation 1s linear infinite;
}

@keyframes progress-animation {
    0% { background-position: 0 0; }
    100% { background-position: 20px 0; }
}

.job-meta {
    display: flex;
    gap: 1rem;
    font-size: 0.8rem;
    color: #6c757d;
}

.advanced-operations-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
}

.operation-section h5 {
    margin-bottom: 0.75rem;
    color: #495057;
}

.operation-section .btn {
    display: block;
    width: 100%;
    margin-bottom: 0.5rem;
    text-align: left;
}

.card-header-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    font-size: 0.9rem;
}

.notification {
    animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.btn-sm {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
}

.form-select, .form-control {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
    border: 1px solid #ced4da;
    border-radius: 4px;
}
</style>
{% endblock %}